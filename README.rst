======
OIOIOI
======

SIO2 is a free platform for carrying out algorithmic contests and OIOIOI is its
main component — the web interface.

Installation
------------

Easy Installer
~~~~~~~~~~~~~~~~~~~~~~~~~

You can easily install and run oioioi out of the box with oioioi_easy_installer.
Just download the oioioi_easy_installer archive, unpack it and run::

  ./oioioi.sh install

to install oioioi. Then you can run::

  ./oioioi.sh start
  ./oioioi.sh stop

to start and stop oioioi.

Make sure to change default superuser password. To do that:
   1. Login to the superuser with default credentials (username:admin, password:admin).
   2. Click username ("admin") in upper-right corner of the webpage.
   3. Click "Change password".
   4. Fill and submit password change form.

You can also update your oioioi instance by typing::

  ./oioioi.sh update

Docker (for deployment)
~~~~~~~~~~~~~~~~~~~~~~~

The easy installer method above uses Docker under the hood. Additionally, you can manually use docker files to create images containing our services.

To run the infrastructure simply::

  "OIOIOI_CONFIGDIR=<config directory>" "OIOIOI_VERSION=<oioioi_version>" docker-compose up

Make sure to change default superuser password, same as in the automatic method.

To start additional number of workers::

  "OIOIOI_CONFIGDIR=<config directory>" "OIOIOI_VERSION=<oioioi_version>" docker-compose up --scale worker=<number>

as described `in Docker docs`_.

.. _in Docker docs: https://docs.docker.com/compose/reference/up/

Docker image
============

Additionally, there is a Docker image provided at (TODO: update this with a link to the docker image, wherever it is hosted).::

  docker run --rm
    --network=sio2-network \
    --name=oioioi-web \
    -e "DATABASE_HOST=db" \
    -e "DATABASE_PORT=5432" \
    -e "DATABASE_NAME=oioioi" \
    -e "DATABASE_USER=oioioi" \
    -e "DATABASE_PASSWORD=password" \
    -e "RABBITMQ_HOST=broker" \
    -e "RABBITMQ_PORT=5672" \
    -e "RABBITMQ_USER=oioioi" \
    -e "RABBITMQ_PASSWORD=password" \
    -e "FILETRACKER_URL=http://web:9999" \
    -e "SIOWORKERS_LISTEN_URL=http://web:7890" \
    -e "ENABLE_SANDBOXED_COMPILERS=True" \
    -p 8000:8000 \
    <TODO: container tag here>

The image is configured through various environment variables:

* database configuration (`DATABASE_...`) is required for the image to work.
* the RabbitMQ broker (`RABBITMQ_...`) is optional, although running it is recommended in production workloads.
* the `FILETRACKER_URL` variable specifies the URL at which the Filetracker server is available to workers (and the OIOIOI instance, if Filetracker is on a separate host).
* the `SIOWORKERS_LISTEN_URL` variable specifies the URL at which the `sioworkersd` worker daemon is available. Usually this is the same machine the main OIOIOI instance is hosted at.
* the `ENABLE_SANDBOXED_COMPILERS` variable instructs the workers to use sanboxed compilers. Those compilers need to be installed manually before enabling this option using the `./manage.py download_sandboxes` command inside the container in the `/sio2/deployment` directory.

Additionally, there are several directories inside the deployment directory that store persistent data, which should be mounted to an external volume:

* `/sio2/deployment/media`, which stores the Filetracker server database, including the sandboxes and user submissions.
* `/sio2/deployment/logs`, which stores the logs generated by all the services.
* `/sio2/deployment/basic_setitngs.py`, which is a file that allows to override the default settings provided by OIOIOI.


Docker (for development)
~~~~~~~~~~~~~~~~~~~~~~~~

Make sure you installed docker properly. The easiest way to do this::

    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh

Start docker service::

    sudo systemctl start docker

Then add yourself to group docker -- to create a group use::

    sudo groupadd docker
    gpasswd -a $USER docker
    newgrp docker

It is possible that you will need to log out and log in. Type docker ps into your terminal to check if everything was installed properly.
If you skip the step above, you will either have to use sudo every time you use docker or use docker above 19.03 version with
experimental features enabled.

Prepare the image with::

    OIOIOI_UID=$(id -u) docker-compose -f docker-compose-dev.yml -f extra/docker/docker-compose-dev-noserver.yml build

Then you can start oioioi with::

    OIOIOI_UID=$(id -u) docker-compose -f docker-compose-dev.yml -f extra/docker/docker-compose-dev-noserver.yml up -d
    OIOIOI_UID=$(id -u) docker-compose -f docker-compose-dev.yml -f extra/docker/docker-compose-dev-noserver.yml exec web python3 manage.py runserver 0.0.0.0:8000

to start the infrastructure in the development mode. Current dirrectory with the source code will be bound to /sio2/oioioi/ inside the running container.

oioioi web interface will be available at localhost:8000, and the user admin with password admin will be created.

Additionally you can bind config files and logs folder to the host::

    id=$(docker create oioioi-dev)  #Create oioioi container
    docker cp $id:/sio2/deployment deployment  #Copy initial deployment folder from oioioi contanier
    docker rm -v $id  #Remove unneeded container

Remember to also uncomment the appropriate volume binding in the web service description in the docker-compose-dev.yml.

Setting up sandboxes and compilers
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In production environments, OIOIOI relies on prebuilt sandboxes and compilers, which standardize and isolate the
enviroment the user submissions are judged in. They can be downloaded after the basic OIOIOI installation is set up,
by running the `./manage.py download_sandboxes` command in the deployment directory.

Installing sandboxes without an internet connection
===================================================

If the machine you're installing OIOIOI on doesn't have an internet connection, you can download the sandboxes beforehand,
and instruct the `download_sandboxes` command to load the files from a local cache instead of the remote server:::

  # if in a docker container, this directory can be bind mounted from the host system
  ./manage.py download_sandboxes -m file:///sio2/sandboxes/MANIFEST -c /sio2/sandboxes # example path, can be something else

All the sandboxes are available at https://downloads.sio2project.mimuw.edu.pl/sandboxes/, and the list of sandboxes
downloaded by default using the command is available at https://downloads.sio2project.mimuw.edu.pl/sandboxes/MANIFEST
Those archives need to be placed directly in the directory that is later passed to the `-c` flag of the command, alongside
the `MANIFEST` and `LICENSE` files.

Running tests on Docker
~~~~~~~~~~~~~~~~~~~~~~~

For testing purposes we use test.sh script located in oioioi directory. Note it's not the same directory
you are connected to after using docker exec -it “web” /bin/bash. The default container id that you should use for running tests is "web"::

    docker-compose -f docker-compose-dev.yml -f extra/docker/docker-compose-dev-noserver.yml exec "web" ../oioioi/test.sh
    docker-compose -f docker-compose-dev.yml -f extra/docker/docker-compose-dev-noserver.yml exec "web" ../oioioi/test.sh oioioi/{name_of_the_app}/

Running static code analysis tools locally (requires Docker)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The static code analysis tools currently in use for python code are black, isort, pep8 and pylint.
All of them can be run locally using the `run_static.sh` shell script.
In order for the script to work the `web` container from docker-compose-dev.yml needs to be running.
The docker image for the project needs to be rebuild if you are migrating from and older Dockerfile version (rebuild the image if you are getting error messages that isort or black are not installed).
Commands for building the image and starting up the containers are listed in the paragraphs above.

When running all tools at once or when running pep8 and pylint independently only the recently modified files (files modified in the most recent commit or staged changes) will be processed.

To run all tools at once::

    ./run_static.sh

To run one of the tools::

    ./run_static.sh black
    ./run_static.sh isort
    ./run_static.sh pylint
    ./run_static.sh pep8

Script toolbox for Docker (development)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Copy-pasting all Docker commands from GitHub can be tedious. Instead use a set of pre-prepared commands embedded into `easy_toolbox.py`.
For help run `easy_toolbox.py -h`. Add custom commands by editing `RAW_COMMANDS` in the file. Script can be used with user-friendly
CLI or by passing commands as arguments.
Developer environment can be easily set up by running::

    ./easy_toolbox.py build
    ./easy_toolbox.py up
    # wait for the scripts to finish migration (up to one minute)
    ./easy_toolbox.py run

For system requirements check `easy_toolbox.py`.

Manual installation (deprecated)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

See `INSTALL`_ for instructions.

.. _INSTALL: INSTALL.rst

Upgrading
---------

See `UPGRADING`_ for instructions.

.. _UPGRADING: UPGRADING.rst

Backup
------

Amanda is recommended for doing OIOIOI backups. Sample configuration with README
is available in ``extra/amanda`` directory.

For developers
--------------

Documentation for developers:

* `Developer's Guide`_
* `Developer's Reference`_

.. _Developer's Guide: CONTRIBUTING.rst
.. _Developer's Reference: http://oioioi.readthedocs.io/en/latest/

Testing
-------

OIOIOI has a big suite of unit tests. You can run them in following way:

* ``test.sh`` - a simple test runner, use from virtualenv
* ``test_selenium.sh`` - long selenium tests, use from virtualenv
* ``tox [path/to/module[::TestClass[::test_method]]] [-- arg1 arg2 ...]`` - runs pytest in isolated environemnt

Supported args:

* ``-n NUM`` - run tests using NUM CPUs
* ``-v`` - increase verbosity
* ``-q`` - decrease verbosity
* ``-x`` - exit after first failure
* ``-lf`` - runs only tests that failed last time
* ``--runslow`` - runs also tests marked as slow

Usage
-----

Well, we don't have a full-fledged User's Guide, but feel free to propose
what should be added here.

Creating task packages
~~~~~~~~~~~~~~~~~~~~~~

To run a contest, you obviously need some tasks. To add a task to a contest in
OIOIOI, you need to create an archive, called task package. Here are some
pointers, how it should look like:

* `tutorial`_,
* `example task packages`_ used by our tests,
* `a rudimentary task package format specification`_.

.. _tutorial: https://github.com/sio2project/oioioi/wiki
.. _example task packages: https://github.com/sio2project/oioioi/tree/master/oioioi/sinolpack/files
.. _a rudimentary task package format specification: http://sio2project.mimuw.edu.pl/display/DOC/Preparing+Task+Packages

Contact us
------------

Here are some useful links:

* `our mailing list`_
* `GitHub issues system`_ (English only)

.. _our mailing list: sio2-project@googlegroups.com
.. _GitHub issues system: http://github.com/sio2project/oioioi/issues
